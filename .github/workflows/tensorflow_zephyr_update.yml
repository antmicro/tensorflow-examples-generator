name: update-tensorflow

on:
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:

jobs:
  generate-examples-job:
    runs-on: ubuntu-18.04
    env:
      GH_SERVICE_ACCOUNT_NAME: "tflite-bot"
      GH_SERVICE_ACCOUNT_EMAIL: "tflite-bot@antmicro.com"
      GH_SERVICE_ACCOUNT_TOKEN: ${{ secrets.GH_SERVICE_ACCOUNT_TOKEN }}
      ZEPHYR_SDK_INSTALL_DIR: "/opt/zephyr-sdk"
    steps:
      - name: Clone target repository
        uses: actions/checkout@v2
        with:
          repository: "antmicro/tensorflow-zephyr-vexriscv-examples"
          path: "target_repo"
          token: ${{ secrets.GH_SERVICE_ACCOUNT_TOKEN }}

      - name: Clone target repository
        uses: actions/checkout@v2
        with:
          repository: "tensorflow/tensorflow"

      - name: Install requirements
        run: |
          sudo apt update
          sudo apt install -y cmake ninja-build gperf ccache dfu-util device-tree-compiler wget python python3-pip python3-setuptools python3-tk python3-wheel xz-utils file make gcc gcc-multilib locales tar curl unzip xxd
          python -m pip install --upgrade pip
          pip install cmake virtualenv

      - name: Install zephyr
        run: |
          wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.11.2/zephyr-sdk-0.11.2-setup.run
          chmod +x zephyr-sdk-0.11.2-setup.run
          ./zephyr-sdk-0.11.2-setup.run -- -d $ZEPHYR_SDK_INSTALL_DIR

      - name: Generate source files tree
        run: |
          cd tensorflow
          make -f tensorflow/lite/micro/tools/make/Makefile TARGET=zephyr_vexriscv magic_wand_bin
          make -f tensorflow/lite/micro/tools/make/Makefile TARGET=zephyr_vexriscv hello_world_bin

      - name: Configure git
        run: |
          git config --global user.name $GH_SERVICE_ACCOUNT_NAME
          git config --global user.email $GH_SERVICE_ACCOUNT_EMAIL

      - name: GH CLI auth
        run: echo $GH_SERVICE_ACCOUNT_TOKEN | gh auth login --with-token

      - name: Bump tensorflow, commit and push
        run: |
          cd $GITHUB_WORKSPACE/tensorflow
          export TENSORFLOW_MASTER=$(git rev-parse --short HEAD)
          cd $GITHUB_WORKSPACE/target_repo
          export NEW_BRANCH=bot-$(date +%F_%H-%M)
          git checkout -b $NEW_BRANCH
          rsync -avh --delete $GITHUB_WORKSPACE/tensorflow/tensorflow/lite/micro/tools/make/gen/zephyr_vexriscv_x86_64_default/prj/*/cmake/tensorflow tensorflow
          git add .
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update Tensorflow to $TENSORFLOW_MASTER";
            git push -u https://$GH_SERVICE_ACCOUNT_NAME:$GH_SERVICE_ACCOUNT_TOKEN@github.com/antmicro/tensorflow-zephyr-vexriscv-examples.git $NEW_BRANCH
            gh pr create --fill --head $NEW_BRANCH
          else
            echo "no changes";
          fi
